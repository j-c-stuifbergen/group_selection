<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Place allocation</title>
</head>
<link rel="stylesheet" type="text/css" href="../index.css" /> 

<body>

<h2>Place allocation</h2>

<form id="dynamicForm">
  <label for="nPlaces">availabel places:</label>
  <input type="number" id="nPlacesInput" name="nPlacesInput" min="1" onkeydown="preventNegativeInput(event)" required><br>
  <label for="numberInput">Enter a group size:</label>
  <input type="number" id="numberInput" name="numberInput" min="1" onkeydown="preventNegativeInput(event)">
  <button type="button" onclick="addNumberBox(this)" >add group</button><br>
</form>

<h3>groups</h3>
<div id="numberBoxes"></div>
<button type="button" id="findCombinations" onclick="findCombinations()" hidden>find combinations</button>


<h3>Results</h3>
<button id="csvDownload1" onclick="download('groups.csv', optimizer.resultCsv())" hidden >Export results to csv file</button>
<p id="output">hit [F12] to view console.</p>
<button id="csvDownload2" onclick="download('groups.csv', optimizer.resultCsv())" hidden>Export results to csv file</button>
<p id="progress_message"></p>

 <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script src="./js/Math_display.js"></script>
<script src="./js/matrix.js"></script>
<script src="./js/groupSelection.js"></script>

<script>

  let storedData = [];

  // Event listener for Enter key to trigger addNumberBox
  document.getElementById('numberInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault(); // Prevent form submission (in case Enter submits the form)
      addNumberBox(); // Trigger the function to add a new number box
    }
  });

// Function to prevent negative numbers by disabling the '-' key
  function preventNegativeInput(event) {
    if (event.key === "-" ) {
      event.preventDefault();  // Prevent "-" key and down arrow
    }
  }

  // Event listener for Enter key to trigger addNumberBox
  document.getElementById('nPlacesInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault(); // Prevent form submission (in case Enter submits the form)
      checkNPlaces(); // Trigger the function to add a new number box
    }
  });

  function addNumberBox() {
    const numberInput = document.getElementById('numberInput');
    const newGroupSize = parseInt(numberInput.value, 10);

    if (isNaN(newGroupSize)) {
      alert('Please enter a valid number');
      return;
    }

    // Check if the newGroupSize already exists as an initial number
    const existingData = storedData.find(item => item.groupSize === newGroupSize);

    if (existingData) {
      alert('  This number has already been used in another box!');
      return;
    }

    // Create a new container for the number box
    const numberBox = document.createElement('div');
    numberBox.classList.add('number-box');

    const id = 'box-' + Date.now(); // Unique ID for each number box
    // Store the initial data
    storedData.push({
      groupSize: newGroupSize,
      nGroups: 1, // Start with N = 1
      id: id
    });
    // Create the minus button
    const minusButton = document.createElement('button');
    minusButton.textContent = '-';
    minusButton.classList.add('buttons');
    minusButton.onclick = () => updateNumber(id, -1);

    // Create the number display element
    const numberDisplay = document.createElement('span');
    numberDisplay.id = id;
    numberDisplay.classList.add('number-display');
    numberDisplay.textContent =groupString(1, newGroupSize);

    // Create the plus button
    const plusButton = document.createElement('button');
    plusButton.textContent = '+';
    plusButton.classList.add('buttons');
    plusButton.onclick = () => updateNumber(id, 1);

    // Append buttons and number display to the container
    numberBox.appendChild(minusButton);
    numberBox.appendChild(numberDisplay);
    numberBox.appendChild(plusButton);

    // Append the new number box to the page
    document.getElementById('numberBoxes').appendChild(numberBox);

    // Reset the input field
    numberInput.value = '';

    // show the findCombinations button
    document.getElementById('findCombinations').removeAttribute("hidden")

    // keep sorted by groupSize
    for (i=storedData.length -2; 0<= i ; i--)
    {   if (newGroupSize < storedData[i].groupSize )
        {   storedData[i+1].groupSize = storedData[i].groupSize
            storedData[i+1].nGroups = storedData[i].nGroups
	    storedData[i].groupSize = newGroupSize
            storedData[i].nGroups = 1
	    updateText(storedData[i+1])
	    updateText(storedData[i])
	}
     }
    
  }

  function updateText(data)
  {
	document.getElementById(data.id).textContent = groupString(data.nGroups, data.groupSize) ;
  }
  function updateNumber(id, change) {
    // Find the stored data by id
    const data = storedData.find(item => item.id === id);
    if (!data) return;

    data.nGroups += change;

    // Update the number display and check if it should disappear
    const numberDisplay = document.getElementById(id);
    if (data.nGroups === 0) {
      // Remove the entire number box from the DOM when N == 0
      const numberBox = numberDisplay.parentElement;
      numberBox.remove();  // Completely remove the box from the DOM
      // Remove the data from the storedData array
      storedData = storedData.filter(item => item.id !== id);
	if (0===storedData.length)
	{     document.getElementById('findCombinations').setAttribute("hidden", 'hidden')

	}
    } else {
	updateText(data)
    }
  }

  function groupString(nGroups, groupSize)
  {  if (1<groupSize)
     {  return "\ "+nGroups+" x "+groupSize+"\ persons\ "
     }
     return "\ "+nGroups+" x "+groupSize+"\ person\ "
  }

  function checkNPlaces()
  {      const nPlaces = parseInt(nPlacesInput.value, 10);
    console.log("nPlaces is"+nPlaces)
    if (isNaN(nPlaces) || 0 ==nPlaces) 
    {   alert("Enter a number (bigger than 0) for the availabel places");
	return false
    }
    return true
   }

  function findCombinations() {
    if (checkNPlaces())
    {   nPlaces = parseInt(nPlacesInput.value, 10);
    }
    else
    { return
    }
    storedData.sort((a, b) => a.groupSize > b.groupSize);
    var displayText = "" 

    document.getElementById('output').textContent = output;

    optimizer = new groups(nPlaces,storedData) // groupSizes,nGroups)

if (optimizer.nCandidates <= nPlaces)
{	displayText += "There is a place for all candidates! <br>\n"
	if (optimizer.nCandidates < nPlaces)
		{	displayText += "And there are " +
				(nPlaces - optimizer.nCandidates) + 
				"places left. <br>\n"
		}
}
else
{
displayText += "<br>There are " +optimizer.nCandidates+ " candidats "
		+ "for only "+ nPlaces + " places. <br>\n"


}
document.getElementById("output").innerHTML = displayText;

progressText = "I am checking possible combinations. <br>\n"
document.getElementById("progress_message").innerHTML = progressText;

console.log("trying combinations...")
optimizer.setCombinations()
if (0 == optimizer.combinations.length)
{	displayText += "Not a single combination of these groups is possible! "
	document.getElementById("output").innerHTML = displayText;
}
else
{

displayText += "<br>number of valid combinations : "+ optimizer.combinations.length
document.getElementById("output").innerHTML = displayText;

progressText += "select combinations... <br>\n"
document.getElementById("progress_message").innerHTML = progressText;

if (! optimizer.selectBestCombinations())
{	displayText += "<br> --- I could not find a good solution ! --- "
}
displayText += "<br> Some selected combinations are <br> \n $$";
var i = 0;
for (i=0; i<8 && i<optimizer.selection.length; i++)
{
	// displayText +=  optimizer.selectedToTex(i)
	displayText +=  optimizer.calculationTeX(i,false)
}
if (i<optimizer.selection.length  )
{	// displayText +=  " .... "
}
displayText += " $$ <br>";
displayText += "Everyone should have a chance of "+nPlaces+" / "+optimizer.nCandidates+" = "+optimizer.pAim +"<br>"
displayText += "<br> I recommend the following probabilities for each combination:";

document.getElementById("output").innerHTML = displayText;

let comb = optimizer.selectionString(optimizer.selection,"\r\n")
console.log(comb["combinations"])
console.log(comb["calculations"])
displayText += "<br>  "+optimizer.resultsTable(5)
displayText += "<br> Quality of the results:";

displayText += "<br>  "+optimizer.chancesTable(3)
document.getElementById("progress_message").innerHTML ="ready.";

document.getElementById("output").innerHTML = displayText;
// Tell MathJax to process the new content

document.getElementById("csvDownload1").removeAttribute("hidden");
document.getElementById("csvDownload2").removeAttribute("hidden");
  MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById("output")]);

}
}
</script>

</body>
</html>

